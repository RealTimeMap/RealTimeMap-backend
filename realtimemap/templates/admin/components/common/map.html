{% macro map_component(geom, obj_id, marker_text) %}
    <div id="map-{{ obj_id }}"
         class="map-display"
         data-geom="{{ geom }}"
         data-marker-text="{{ marker_text }}">
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Получаем все элементы карт на странице
            const mapElements = document.querySelectorAll('[id^="map-"]');

            mapElements.forEach(function (mapElement) {
                const geomString = mapElement.dataset.geom;
                const objId = mapElement.id.split('-')[1];
                const markerText = mapElement.dataset.markerText;

                initMap(geomString, objId, markerText, mapElement);
            });
        });

        async function initMap(geomString, objId, markerText, mapElement) {
            console.log('initMap called with:', {geomString, objId, markerText});

            if (!geomString || geomString.indexOf(',') === -1) {
                mapElement.innerHTML = '<p class="empty-state">Invalid coordinates to display map.</p>';
                return;
            }

            // Парсим координаты в формате "longitude, latitude"
            const coords = geomString.split(',').map(s => s.trim()).map(Number);
            console.log('Parsed coordinates:', coords);

            await ymaps3.ready;
            ymaps3.import.registerCdn(
                'https://cdn.jsdelivr.net/npm/{package}',
                '@yandex/ymaps3-default-ui-theme@latest'
            );

            const {YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer} = ymaps3;
            const {YMapDefaultMarker} = await ymaps3.import('@yandex/ymaps3-default-ui-theme');
            console.log('YMapDefaultMarker imported');

            const map = new YMap(
                mapElement,
                {
                    location: {
                        center: coords,
                        zoom: 15
                    },
                    behaviors: ['pinchZoom', 'scrollZoom', 'dblClick']
                }
            );
            map.addChild(new YMapDefaultSchemeLayer());
            map.addChild(new YMapDefaultFeaturesLayer());

            // Добавляем маркер на карту используя YMapDefaultMarker
            const marker = new YMapDefaultMarker({
                coordinates: coords,
                title: markerText || 'Marker',
                color: 'red'
            });

            console.log('Marker created:', marker);
            map.addChild(marker);
            console.log('Marker added to map');
        }
    </script>
{% endmacro %}